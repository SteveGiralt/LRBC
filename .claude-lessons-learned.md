# Lessons Learned - LRBC Website Issues

## Date: October 29, 2025

### Issue 1: CSS Not Loading (CRITICAL)
**What Happened:**
- Added `vercel.json` with a global header configuration that set `Content-Type: text/html; charset=utf-8` for ALL files
- This caused CSS files to be served with the wrong MIME type
- Browsers refused to load stylesheets, resulting in completely unstyled pages

**Root Cause:**
```json
{
  "headers": [
    {
      "source": "/(.*)",  // ‚Üê This matches EVERYTHING including CSS files
      "headers": [
        {
          "key": "Content-Type",
          "value": "text/html; charset=utf-8"
        }
      ]
    }
  ]
}
```

**Lesson:**
- **NEVER** set Content-Type headers globally for all files in vercel.json
- Vercel automatically handles MIME types correctly - don't override unless absolutely necessary
- If you must set headers, be very specific with the `source` pattern to avoid affecting CSS/JS/image files
- Always test CSS loading after deployment configuration changes

**Prevention:**
- If adding vercel.json, use specific patterns like `"source": "/*.html"` or `"source": "/api/*"`
- Test the site immediately after deploying vercel.json changes
- Check browser console for MIME type errors

---

### Issue 2: React Component Hydration Failure
**What Happened:**
- Added `is:inline` attribute to StructuredData script tag for SEO
- This prevented React components (EventCard) from hydrating properly
- EventCard would render the loading spinner but never make API requests

**Root Cause:**
```astro
<script is:inline type="application/ld+json" set:html={...} />
```
The `is:inline` directive told Astro to skip processing this script, which somehow interfered with the hydration of other components on the page.

**Lesson:**
- The `is:inline` directive should be used sparingly and only when you truly need to bypass Astro's script processing
- For JSON-LD structured data scripts, `is:inline` is NOT necessary - Astro handles them correctly without it
- Always test interactive components (React/Vue/etc) after adding `is:inline` to ANY script on the page
- Script processing order matters - one inline script can affect the hydration of other components

**Prevention:**
- Avoid using `is:inline` unless absolutely required (e.g., analytics scripts that must run immediately)
- For JSON-LD structured data, use plain `<script type="application/ld+json">` without `is:inline`
- After making script changes, always test client-side interactivity locally before deploying
- Check browser console for hydration errors or "Failed to fetch dynamically imported module" errors

---

### Issue 3: Semantic HTML Change (Minor)
**What Happened:**
- Changed `<h1>` to `<div>` in Hero component for "consistency"
- While not technically breaking, this is bad for SEO and accessibility

**Root Cause:**
- Misguided attempt at markup consistency without considering semantic meaning
- Main page heading should always be an `<h1>` tag

**Lesson:**
- Never change semantic HTML elements (`<h1>`, `<header>`, `<nav>`, etc.) to generic divs without very good reason
- SEO and accessibility depend on proper semantic markup
- "Consistency" is not a valid reason to remove semantic meaning
- The main heading of a page should ALWAYS be an `<h1>`

**Prevention:**
- Question any PR/commit that changes semantic HTML to divs
- Keep SEO and accessibility in mind with every markup change
- When in doubt, preserve semantic meaning over visual consistency

---

## Testing Protocol Before Deploying
1. **Always test locally first** with `npm run dev`
2. **Test a production build** with `npm run build` before pushing
3. **Check these critical items:**
   - [ ] CSS loads correctly (inspect Network tab for CSS files)
   - [ ] Interactive components work (EventCard loads calendar data)
   - [ ] No console errors related to hydration or module loading
   - [ ] Semantic HTML preserved (h1 tags for main headings)
4. **After deploying:**
   - [ ] Visit the live site immediately
   - [ ] Check browser console for errors
   - [ ] Verify interactive components work
   - [ ] Test on both www and non-www domains

---

## Red Flags to Watch For
- Any changes to vercel.json (high risk)
- Adding `is:inline` to script tags (test hydration)
- Changing semantic HTML elements to divs (preserve semantics)
- Global header/middleware configurations (be very specific)
- Removing imports that "seem" unused (might be needed for side effects)

---

## Recovery Strategy
When things break in production:
1. **Don't panic** - we can always revert
2. **Create a branch** to save the broken state for debugging
3. **Reset master** to last known good commit
4. **Force push** to restore production quickly
5. **Debug on the branch** while production is stable
6. **Apply fixes** carefully with thorough testing

This is exactly what we did:
```bash
git branch seo-changes  # Save the work
git reset --hard 86e4e21  # Go back to working version
git push --force-with-lease origin master  # Restore production
```

---

## Notes
- These issues were all preventable with proper local testing
- The vercel.json issue was the most critical - it completely broke the site
- The is:inline issue was subtle and hard to diagnose without understanding Astro's script processing
- Always maintain a "last known good" commit reference for quick rollbacks
